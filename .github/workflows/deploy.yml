- name: Deploy on VM (as user)
  uses: azure/cli@v2
  with:
    inlineScript: |
      az vm run-command invoke \
        --resource-group "${{ secrets.AZ_RG }}" \
        --name "${{ secrets.AZ_VM }}" \
        --command-id RunShellScript \
        --scripts '
          set -euo pipefail

          # root: ensure system deps
          command -v node >/dev/null || (curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash - && sudo apt -y install nodejs build-essential)
          sudo npm i -g yarn pm2

          # run the rest as the login user
          sudo -u aum-sitrai bash -lc "
            set -euo pipefail
            APP_DIR=\$HOME/aum-ai
            REPO=https://github.com/sumanrajsah/aum-ai.git

            mkdir -p \$APP_DIR
            cd \$APP_DIR

            if [ ! -d .git ]; then
              git clone \$REPO .
            fi

            git fetch --all
            git reset --hard origin/main

            cat > .env.production <<EOF
            NEXT_PUBLIC_API_URI=${{ secrets.NEXT_PUBLIC_API_URI }}
            NEXT_PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}
            EOF

            yarn install --frozen-lockfile
            yarn build

            pm2 describe aum-ai >/dev/null && pm2 reload aum-ai || pm2 start node_modules/next/dist/bin/next --name aum-ai -- start
            pm2 save
          "
        '
